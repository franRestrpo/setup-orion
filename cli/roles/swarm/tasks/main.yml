- name: Check if swarm mode is active
  command: docker info
  register: docker_info
  changed_when: false

- name: Initialize swarm
  command: "docker swarm init --advertise-addr {{ ansible_default_ipv4.address }}"
  when: "'Swarm: inactive' in docker_info.stdout"

- name: Get swarm manager join token
  command: docker swarm join-token manager -q
  register: manager_token
  when: "'Swarm: inactive' in docker_info.stdout"
  changed_when: false

- name: Get swarm worker join token
  command: docker swarm join-token worker -q
  register: worker_token
  when: "'Swarm: inactive' in docker_info.stdout"
  changed_when: false

- name: Display swarm join commands
  debug:
    msg:
      - "Manager join command: docker swarm join --token {{ manager_token.stdout }} {{ ansible_default_ipv4.address }}:2377"
      - "Worker join command: docker swarm join --token {{ worker_token.stdout }} {{ ansible_default_ipv4.address }}:2377"
  when: manager_token.stdout is defined

- name: Create overlay network
  docker_network:
    name: DOCKER-SWARM
    driver: overlay
    attachable: yes
